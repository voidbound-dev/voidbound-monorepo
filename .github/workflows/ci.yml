name: CI Pipeline

# –û–ø–∏—Å–∞–Ω–∏–µ: –ë–∞–∑–æ–≤—ã–π CI-–ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫–æ–¥–∞ –≤ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ Voidbound: Chronoscape.
# –í–∫–ª—é—á–∞–µ—Ç –ª–∏–Ω—Ç–∏–Ω–≥, —Å–±–æ—Ä–∫—É –∏ —Ç–µ—Å—Ç—ã.

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  pull-requests: write
  contents: read

jobs:
  build-and-test:
    name: Lint, Build and Test
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã Turbo –≤ —Ä–µ–∂–∏–º–µ PR

      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pnpm (–≤–µ—Ä—Å–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ package.json)
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.1

      # 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º pnpm
      - name: Setup Node.js (20.x)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ .turbo –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—Å—Ç—Ä–æ–≥–æ –ø–æ lock-—Ñ–∞–π–ª—É)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 6. –õ–∏–Ω—Ç–∏–Ω–≥ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Turbo –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–æ –≤—Å–µ—Ö –ø–∞–∫–µ—Ç–∞—Ö)
      - name: Lint
        run: pnpm lint

      # 7. –°–±–æ—Ä–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Turbo)
      - name: Build
        run: pnpm build

      # 8. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Turbo)
      - name: Test
        run: pnpm test

      # 9. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, GitHub Actions –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
      - name: PR Success Comment
        if: success() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ‚úÖ **CI Pipeline Passed!**
            - üîç **Linting:** OK
            - üõ† **Build:** OK
            - üß™ **Tests:** OK
          comment_tag: ci_status

      - name: PR Failure Comment
        if: failure() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ‚ùå **CI Pipeline Failed!**
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫.
          comment_tag: ci_status
